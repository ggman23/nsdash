<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moyennes Journalières</title>
  <style>
    body {
      background: #0a0f1a;
      color: #e6eef7;
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 5px;
      min-height: 100vh;
      overflow-x: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .back-btn {
      background: #0c121b;
      border: 1px solid #223049;
      color: #e6eef7;
      padding: 6px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
    }
    
    .title {
      text-align: center;
      font-size: 20px;
      margin-bottom: 15px;
    }
    
.calendar-container {
  margin-bottom: 20px;
  width: 100%;
  padding: 0;
} 
   
.calendar {
  display: grid;
  grid-template-columns: 120px repeat(31, 1fr) 80px;
  gap: 1px;
  margin-bottom: 2px;
  width: 100%;
}    
    .month-name {
      background: #1a2332;
      padding: 5px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
 .calendar-day {
  background: #121823;
  border: 1px solid #1f2b3b;
  padding: 2px;
  text-align: center;
  font-size: 11px;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  min-width: 0;
}   
    .month-average {
      background: #1a2332;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .day-header {
      background: #2a3441;
      font-weight: bold;
      color: #9aa4b2;
    }
    
 .chart-container {
  margin-top: 20px;
  width: 100%;
  padding: 0;
}   
    .chart-title {
      font-size: 18px;
      margin-bottom: 10px;
    }
 
#dailyChart {
  border: 1px solid #223049;
  border-radius: 8px;
  width: 100% !important;
  height: 250px !important;
}   
  </style>
</head>
<body>
  <div class="header">
    <div>
      <a href="/test/index.html" class="back-btn">← Dashboard</a>
      <a href="/test/stats.html" class="back-btn" style="margin-left: 10px;">Stats</a>
    </div>
    <div id="datetime">--</div>
  </div>
  
  <div class="title" id="yearlyTitle">Glycémie moyenne sur l'année : -- mg/dL</div>
  
  <div class="calendar-container" id="calendarContainer">
    <!-- Le tableau sera généré ici -->
  </div>
  
  <div class="chart-container">
    <div class="chart-title">Évolution des moyennes quotidiennes</div>
    <canvas id="dailyChart" width="1200" height="250"></canvas>
  </div>

  <script>
    let D90 = [];
    let dailyAverages = {};
    let yearlyAverage = 0;

    async function fetchData() {
      try {
        const response = await fetch('/ns/api/v1/entries.json?count=50000');
        const data = await response.json();
        D90 = data.map(entry => ({
          date: new Date(entry.date).getTime(),
          sgv: entry.sgv
        })).reverse();
        
        calculateDailyAverages();
        generateCalendars();
drawDailyChart();
        updateDateTime();
      } catch (error) {
        console.error('Erreur récupération données:', error);
      }
    }

    function calculateDailyAverages() {
      const dailyData = {};
      let totalSum = 0;
      let totalCount = 0;

      D90.forEach(entry => {
        const date = new Date(entry.date);
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        if (!dailyData[dateKey]) {
          dailyData[dateKey] = [];
        }
        dailyData[dateKey].push(entry.sgv);
      });

      for (const [date, values] of Object.entries(dailyData)) {
        if (values.length > 0) {
          const average = Math.round(values.reduce((sum, val) => sum + val, 0) / values.length);
          dailyAverages[date] = average;
          totalSum += average;
          totalCount++;
        }
      }

      if (totalCount > 0) {
        yearlyAverage = Math.round(totalSum / totalCount);
        document.getElementById('yearlyTitle').textContent = `Glycémie moyenne sur l'année : ${yearlyAverage} mg/dL`;
      }
    }

    function getGlucoseColor(glucose) {
      if (glucose === null || glucose === undefined) return '#444444';
      if (glucose < 70 || glucose > 200) return '#ef4444';
      if ((glucose >= 70 && glucose < 90) || (glucose > 180 && glucose <= 200)) return '#f59e0b';
      return '#22c55e';
    }

    function generateCalendars() {
      const container = document.getElementById('calendarContainer');
      const currentYear = new Date().getFullYear();
      
      // En-tête avec numéros des jours
      const headerRow = document.createElement('div');
      headerRow.className = 'calendar';
      
      const emptyHeader = document.createElement('div');
      emptyHeader.className = 'month-name';
      headerRow.appendChild(emptyHeader);
      
      for (let day = 1; day <= 31; day++) {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day day-header';
        dayHeader.textContent = day;
        headerRow.appendChild(dayHeader);
      }
      
      const avgHeader = document.createElement('div');
      avgHeader.className = 'month-average';
      avgHeader.textContent = 'Moy';
      headerRow.appendChild(avgHeader);
      
      container.appendChild(headerRow);
      
      // Mois de septembre à août
      const months = [
        { num: 8, name: 'Sep', year: currentYear - 1 },
        { num: 9, name: 'Oct', year: currentYear - 1 },
        { num: 10, name: 'Nov', year: currentYear - 1 },
        { num: 11, name: 'Déc', year: currentYear - 1 },
        { num: 0, name: 'Jan', year: currentYear },
        { num: 1, name: 'Fév', year: currentYear },
        { num: 2, name: 'Mar', year: currentYear },
        { num: 3, name: 'Avr', year: currentYear },
        { num: 4, name: 'Mai', year: currentYear },
        { num: 5, name: 'Juin', year: currentYear },
        { num: 6, name: 'Juil', year: currentYear },
        { num: 7, name: 'Août', year: currentYear }
      ];

      months.forEach(month => {
        const monthRow = document.createElement('div');
        monthRow.className = 'calendar';
        
        const monthName = document.createElement('div');
        monthName.className = 'month-name';
        monthName.textContent = month.name;
        monthRow.appendChild(monthName);
        
        let monthSum = 0;
        let monthCount = 0;
        
        for (let day = 1; day <= 31; day++) {
          const cell = document.createElement('div');
          cell.className = 'calendar-day';
          
          const date = new Date(month.year, month.num, day);
          if (date.getMonth() === month.num) {
            const dateKey = `${month.year}-${String(month.num + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const average = dailyAverages[dateKey];
            
            if (average) {
              cell.textContent = average;
              cell.style.backgroundColor = getGlucoseColor(average);
              cell.style.color = '#fff';
              monthSum += average;
              monthCount++;
            }
          } else {
            cell.style.background = 'transparent';
            cell.style.border = 'none';
          }
          
          monthRow.appendChild(cell);
        }
        
        const monthAvgCell = document.createElement('div');
        monthAvgCell.className = 'month-average';
        if (monthCount > 0) {
          const monthAvg = Math.round(monthSum / monthCount);
          monthAvgCell.textContent = monthAvg;
          monthAvgCell.style.backgroundColor = getGlucoseColor(monthAvg);
          monthAvgCell.style.color = '#fff';
        }
        monthRow.appendChild(monthAvgCell);
        
        container.appendChild(monthRow);
      });
    }


function drawDailyChart() {
  const canvas = document.getElementById('dailyChart');
  const container = canvas.parentElement;
  
  // Ajuster la taille au conteneur pour utiliser toute la largeur
  canvas.width = container.clientWidth - 20;
  canvas.height = 250;
  canvas.style.width = (container.clientWidth - 20) + 'px';
  canvas.style.height = '250px';
  
  // Préparer les données
  const sortedDates = Object.keys(dailyAverages).sort();
  const chartData = sortedDates.map(date => ({
    x: new Date(date),
    y: dailyAverages[date]
  }));

  if (chartData.length === 0) return;

  // Graphique simple avec canvas natif pour contrôler totalement la largeur
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Dessiner le graphique des moyennes quotidiennes
  if (chartData.length > 1) {
    const margin = 40;
    const chartWidth = canvas.width - (margin * 2);
    const chartHeight = canvas.height - (margin * 2);
    
    const minY = Math.min(...chartData.map(d => d.y)) - 20;
    const maxY = Math.max(...chartData.map(d => d.y)) + 20;
    
    ctx.strokeStyle = '#22c55e';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    chartData.forEach((point, index) => {
      const x = margin + (index * chartWidth) / (chartData.length - 1);
      const y = margin + chartHeight - ((point.y - minY) / (maxY - minY)) * chartHeight;
      
      if (index === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
      
      // Changer la couleur selon la valeur
      const color = getGlucoseColor(point.y);
      ctx.fillStyle = color;
      ctx.fillRect(x - 2, y - 2, 4, 4);
    });
    
    ctx.stroke();
  }
}


    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = 
        now.toLocaleDateString('fr-FR') + ' ' + 
        now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    }

    document.addEventListener('DOMContentLoaded', function() {
      fetchData();
      setInterval(updateDateTime, 1000);
    });
  </script>
</body>
</html>
