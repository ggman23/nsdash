<!doctype html><html lang="fr"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NS Dash PROD</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
<style>
  :root{--bg:#0f1220;--fg:#f7f7fb;--muted:#9aa3b2}
  *{box-sizing:border-box}html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;overflow:hidden}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;gap:12px;height:100vh;padding:14px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .pill{background:#1a1f36;border:1px solid #28304a;padding:.35rem .6rem;border-radius:999px;color:var(--muted)}
  .bigline{display:grid;grid-template-columns:auto 1fr auto;align-items:end;gap:14px}
  .clock{font-weight:800;font-size:46px}
  .current{font-weight:900;font-size:64px}
  .trend{font-weight:900;font-size:54px;margin-left:6px}
  .deltaBox{display:flex;flex-direction:column;align-items:flex-end}
  .delta{font-weight:800;font-size:46px}.ago{color:var(--muted);font-size:18px;margin-top:4px}
  canvas{width:100%!important;height:100%!important}
  .card{background:#121733;border:1px solid #28304a;border-radius:16px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .kpi{background:#0f1430;border:1px solid #1f2747;border-radius:12px;padding:10px;text-align:center}
  .kpi h3{margin:0 0 6px 0;color:var(--muted);font-weight:600;font-size:15px}
  .kpi .v{font-weight:900;font-size:24px}
  .title{font-weight:700}
</style>
</head><body><div class="wrap">

  <div class="row">
    <div class="pill" id="rangeLbl">Dernières 12 h</div>
    <div class="pill" id="nsLbl">ns: —</div>
  </div>

  <div class="card">
    <div class="bigline">
      <div class="clock" id="clock">--:--</div>
      <div class="row" style="justify-content:center">
        <div class="current" id="curr">—</div>
        <div class="trend" id="trend">—</div>
      </div>
      <div class="deltaBox">
        <div class="delta" id="delta">Δ0</div>
        <div class="ago" id="ago">—</div>
      </div>
    </div>
    <div style="height:62vh;margin-top:8px"><canvas id="g"></canvas></div>
  </div>

  <section class="card">
    <div class="row"><span class="title">Indicateurs</span><span class="pill" id="updated">-</span></div>
    <div class="grid">
      <div class="kpi"><h3>Min</h3><div class="v" id="kMin">—</div></div>
      <div class="kpi"><h3>Moyenne</h3><div class="v" id="kAvg">—</div></div>
      <div class="kpi"><h3>Max</h3><div class="v" id="kMax">—</div></div>
      <div class="kpi"><h3>GMI estimée</h3><div class="v" id="kGmi">—</div></div>
      <div class="kpi"><h3>TIR 70–180</h3><div class="v" id="kTir">—</div></div>
      <div class="kpi"><h3>GMI 90 j</h3><div class="v" id="kGmi90">—</div></div>
      <div class="kpi"><h3>TIR 90 j</h3><div class="v" id="kTir90">—</div></div>
    </div>
  </section>

</div>
<script>
const params=new URLSearchParams(location.search);
let ns=params.get('ns')||'/';
const token=params.get('token')||'';
const hours=12;

document.getElementById('rangeLbl').textContent='Dernières '+hours+' h';
document.getElementById('nsLbl').textContent='ns: '+ns;

// Corrige ns=127.0.0.1/localhost quand on n'est PAS sur le Pi
function fixLocalNS(n) {
  try {
    const u=new URL(n);
    if ((u.hostname==='127.0.0.1'||u.hostname==='localhost') && location.hostname!=='127.0.0.1' && location.hostname!=='localhost') {
      return location.protocol+'//'+location.hostname+':1337';
    }
    return n;
  } catch { return n; }
}

function resolveNS() {
  n = (ns==='/'||ns==='/ns') ? location.origin : fixLocalNS(ns);
  return n.replace(/\/$/,'');
}
function fmtTime(ts){const d=new Date(ts);return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',hour12:false});}
function timeAgo(ts){const m=Math.round((Date.now()-ts)/60000);return m<=1?'il y a 1 min':`il y a ${m} min`;}
function colorFor(y){
  if (y<70) return '#ff4d4f';
  if (y<90) return '#ffd666';
  if (y<=180) return '#52c41a';
  if (y<=200) return '#ffd666';
  return '#ff4d4f';
}
function dirArrow(v1,v2){
  const d=v2-v1;
  if (d>6) return '↑';
  if (d>3) return '↗';
  if (d<-6) return '↓';
  if (d<-3) return '↘';
  return '→';
}
let chart=null;

async function load() {
  const base=resolveNS();
  const count=Math.round(hours*12*1.3);
  const url=base+'/api/v1/entries/sgv.json?count='+count+(token?('&token='+encodeURIComponent(token)):'');
  const resp=await fetch(url,{cache:'no-store'});
  if(!resp.ok) throw new Error('HTTP '+resp.status);
  const data=await resp.json();

  const pts=data.slice().reverse().map(e=>({t:new Date(e.date), y:e.sgv}));
  if (!pts.length) throw new Error('Aucune donnée');
  const tmax=pts.at(-1).t.getTime(), tmin=tmax-hours*3600*1000;
  const inwin=pts.filter(p=>p.t>=tmin);
  const ys=inwin.map(p=>p.y);
  const min=Math.min(...ys), max=Math.max(...ys);
  const avg=ys.reduce((a,b)=>a+b,0)/ys.length;
  const tir=ys.filter(v=>v>=70&&v<=180).length/ys.length*100;
  const gmi=3.31+0.02392*avg;

  const last=inwin.at(-1), prev=inwin.at(-2)||inwin.at(-1);
  const delta=(last.y-prev.y);
  const arrow=dirArrow(prev.y,last.y);

  document.getElementById('clock').textContent=fmtTime(last.t);
  document.getElementById('curr').textContent=Math.round(last.y);
  document.getElementById('trend').textContent=arrow;
  const dSign=delta>0?`+${Math.round(delta)}`:`${Math.round(delta)}`;
  document.getElementById('delta').textContent='Δ'+dSign;
  document.getElementById('ago').textContent=timeAgo(last.t);
  document.getElementById('updated').textContent=new Date().toLocaleTimeString('fr-FR',{hour12:false});

  const r=v=>isFinite(v)?v.toFixed(0):'—';
  document.getElementById('kMin').textContent=r(min);
  document.getElementById('kMax').textContent=r(max);
  document.getElementById('kAvg').textContent=isFinite(avg)?avg.toFixed(0):'—';
  document.getElementById('kTir').textContent=isFinite(tir)?tir.toFixed(0)+'%':'—';
  document.getElementById('kGmi').textContent=isFinite(gmi)?gmi.toFixed(2)+'%':'—';

  (async ()=>{
    try{
      const url90=base+'/api/v1/entries/sgv.json?count='+(Math.round(90*24*12*1.05))+(token?('&token='+encodeURIComponent(token)):'');
      const d90=await fetch(url90,{cache:'no-store'}).then(r=>r.json());
      const ys90=d90.map(e=>e.sgv);
      const avg90=ys90.reduce((a,b)=>a+b,0)/ys90.length;
      const tir90=ys90.filter(v=>v>=70&&v<=180).length/ys90.length*100;
      document.getElementById('kGmi90').textContent=(3.31+0.02392*avg90).toFixed(2)+'%';
      document.getElementById('kTir90').textContent=tir90.toFixed(0)+'%';
    }catch{}
  })();

  const yMin=Math.max(40, Math.floor((min-10)/10)*10);
  const yMax=Math.min(400, Math.ceil((max+10)/10)*10);
  const labels=inwin.map(p=>p.t);
  const values=inwin.map(p=>p.y);

  const ctx=document.getElementById('g').getContext('2d');
  if (chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{labels, datasets:[{
      data:values, borderWidth:3, pointRadius:0, fill:false,
      segment:{borderColor: c => {
        const a=c.p0?.parsed?.y, b=c.p1?.parsed?.y;
        const y=( (a??b)+(b??a) )/2; return colorFor(y);
      }}
    }]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{legend:{display:false}, tooltip:{enabled:true, callbacks:{label:it=>`${Math.round(it.parsed.y)} mg/dL`}}},
      scales:{
        x:{type:'time', time:{unit:'hour', displayFormats:{hour:'HH:mm'}},
           ticks:{color:'#fff'}, grid:{color:'#2a3357'}},
        y:{min:yMin,max:yMax, ticks:{color:'#fff'}, grid:{color:'#2a3357'}}
      }
    }
  });
}

function safeLoad(){load().catch(e=>{console.error('NS load error:',e);});}
safeLoad();
setInterval(safeLoad, 60_000);
</script>
</body></html>
